<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anomaly Watch: AI Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Sarabun:wght@400;700&display=swap');

        body {
            margin: 0; padding: 0; background-color: #000;
            overflow: hidden; color: #ccc;
            font-family: 'VT323', monospace;
            user-select: none; -webkit-user-select: none;
        }

        #game-container {
            width: 100vw; height: 100vh; position: relative;
            display: flex; flex-direction: column;
        }

        /* SCREEN EFFECT */
        .scanlines {
            position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 10;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%; opacity: 0.6;
        }
        .vignette {
            position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 11;
            background: radial-gradient(circle, transparent 60%, rgba(0,10,0,0.9) 100%);
        }

        /* MONITOR */
        #monitor {
            flex: 1; position: relative; background: #050505;
            display: flex; justify-content: center; align-items: center;
            border-bottom: 2px solid #333; overflow: hidden;
        }
        canvas {
            width: 100%; height: 100%; object-fit: contain;
            filter: contrast(1.2) brightness(1.1) sepia(0.4) hue-rotate(50deg) grayscale(0.2); 
        }
        #cam-info {
            position: absolute; top: 20px; left: 20px; font-size: 30px; color: #fff; text-shadow: 0 0 5px #0f0;
            display: flex; gap: 20px; z-index: 5; background: rgba(0,0,0,0.5); padding: 5px 10px; border: 1px solid #0f0;
        }
        .rec-dot { color: red; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* CONTROLS */
        #controls {
            height: 280px; background: #111; border-top: 5px solid #222;
            display: grid; grid-template-columns: 220px 1fr 200px; gap: 10px; padding: 10px;
        }
        
        @media (max-width: 800px) {
            #controls { display: flex; flex-direction: column; height: auto; max-height: 40vh; overflow-y: auto; }
            .cam-list { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; height: auto; }
        }

        .cam-list { display: flex; flex-direction: column; gap: 5px; }
        .cam-btn {
            background: #222; border: 1px solid #444; color: #888;
            padding: 8px; font-family: 'VT323'; font-size: 22px; cursor: pointer; text-align: left;
        }
        .cam-btn:hover { background: #333; }
        .cam-btn.active { background: #003300; color: #0f0; border-color: #0f0; box-shadow: 0 0 10px #0f0; }

        .report-panel {
            border: 1px solid #444; padding: 10px; background: #080808;
            display: flex; flex-direction: column; gap: 10px;
        }
        .report-title { font-size: 24px; color: #f00; text-align: center; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .anomaly-types { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; overflow-y: auto; max-height: 150px; }
        .type-btn {
            background: #222; border: 1px solid #555; color: #aaa; padding: 10px; cursor: pointer; font-family: 'Sarabun'; font-size: 14px;
        }
        .type-btn:hover { background: #400; color: #fff; border-color: #f00; }
        
        .status-panel { display: flex; flex-direction: column; justify-content: space-between; text-align: right; }
        .stat-row { font-size: 24px; }
        #anomaly-count { color: #0f0; }
        #anomaly-count.warning { color: #ff0; }
        #anomaly-count.danger { color: #f00; animation: blink 0.5s infinite; }

        /* SCREENS (Common) */
        .screen-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            z-index: 50; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
        }

        /* Dark Screens (Game Over / Win) */
        .screen-dark { background: #000; color: #fff; }
        .screen-dark h1 { font-size: 80px; margin: 0; text-shadow: 0 0 10px #fff; letter-spacing: 5px; }
        .screen-dark .btn-start {
            margin-top: 30px; padding: 15px 60px; border: 2px solid #fff; background: #002200;
            color: #0f0; font-family: 'VT323'; font-size: 30px; cursor: pointer; transition: 0.2s;
        }
        .screen-dark .btn-start:hover { background: #0f0; color: #000; }
        .screen-dark .ai-box { font-family: 'Sarabun'; font-size: 18px; color: #aaa; font-style: italic; margin: 20px; max-width: 600px; padding: 10px; border: 1px dashed #555; }

        /* WHITE MENU SCREEN */
        #menu-screen {
            background-color: #ffffff;
            color: #000000;
        }
        #menu-screen h1 {
            font-size: 80px; margin: 0; color: #000; letter-spacing: 10px;
            text-transform: uppercase; font-weight: bold;
            border-bottom: 5px solid #000; padding-bottom: 10px; margin-bottom: 10px;
        }
        #menu-screen p {
            color: #000; font-size: 20px; font-weight: bold; letter-spacing: 5px; margin-bottom: 20px;
        }
        
        /* How to Play Box */
        #how-to-play {
            border: 2px solid #000;
            padding: 20px;
            margin: 10px;
            text-align: left;
            font-family: 'Sarabun', sans-serif;
            font-size: 16px;
            line-height: 1.5;
            background: #f4f4f4;
            width: 90%;
            max-width: 550px;
            box-shadow: 8px 8px 0px #888;
        }
        #how-to-play h2 {
            font-family: 'Sarabun'; font-weight: bold; font-size: 20px; margin-top: 0; 
            border-bottom: 1px solid #000; margin-bottom: 10px; display: inline-block;
        }
        #how-to-play ul { padding-left: 20px; margin: 0; }
        #how-to-play li { margin-bottom: 4px; }

        #menu-screen .btn-start {
            margin-top: 25px; padding: 12px 60px; 
            border: 2px solid #000; background: #fff;
            color: #000; font-family: 'Sarabun'; font-size: 24px; font-weight: bold;
            cursor: pointer; transition: all 0.2s;
        }
        #menu-screen .btn-start:hover {
            background: #000; color: #fff;
        }
        
        /* AI Log Button */
        #btn-log {
            margin-top: 10px; padding: 10px 30px; 
            border: 1px dashed #000; background: transparent;
            color: #555; font-family: 'Sarabun'; font-size: 18px; 
            cursor: pointer; transition: all 0.2s;
        }
        #btn-log:hover { background: #eee; color: #000; }

        #menu-screen .ai-box {
            font-family: 'Sarabun'; font-size: 16px; color: #555; 
            font-style: italic; margin-top: 15px; border-left: 3px solid #ccc; padding-left: 10px;
            min-height: 40px; display: flex; align-items: center; justify-content: center;
        }

        #msg-flash {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 40px; color: #fff; text-shadow: 0 0 10px #fff; 
            pointer-events: none; opacity: 0; z-index: 20; transition: opacity 0.5s;
            background: rgba(0,0,0,0.8); padding: 20px; border: 2px solid #fff;
        }

    </style>
</head>
<body>

    <div class="scanlines"></div>
    <div class="vignette"></div>

    <div id="game-container">
        <!-- MONITOR -->
        <div id="monitor">
            <div id="cam-info">
                <span class="rec-dot">●</span>
                <span id="curr-cam-name">LIVING ROOM</span>
                <span id="time-display" style="margin-left: 30px;">00:00 AM</span>
            </div>
            <div id="msg-flash">REPORT SENT</div>
            <canvas id="gameCanvas"></canvas>
        </div>

        <!-- CONTROLS -->
        <div id="controls">
            <!-- Camera List -->
            <div class="cam-list">
                <button class="cam-btn active" onclick="Game.switchCam(0)">[1] LIVING ROOM</button>
                <button class="cam-btn" onclick="Game.switchCam(1)">[2] KITCHEN</button>
                <button class="cam-btn" onclick="Game.switchCam(2)">[3] BEDROOM</button>
                <button class="cam-btn" onclick="Game.switchCam(3)">[4] BATHROOM</button>
            </div>

            <!-- Report Menu -->
            <div class="report-panel">
                <div class="report-title">REPORT ANOMALY</div>
                <div class="anomaly-types">
                    <button class="type-btn" onclick="Game.report('Intruder')">Intruder (ผี/เงา)</button>
                    <button class="type-btn" onclick="Game.report('Displacement')">Moved (ของขยับ)</button>
                    <button class="type-btn" onclick="Game.report('Extra')">Extra (ของเกิน)</button>
                    <button class="type-btn" onclick="Game.report('Missing')">Missing (ของหาย)</button>
                    <button class="type-btn" onclick="Game.report('Door')">Door (ประตู/ตู้)</button>
                    <button class="type-btn" onclick="Game.report('Camera')">Camera (กล้องเสีย)</button>
                </div>
            </div>

            <!-- Status -->
            <div class="status-panel">
                <div class="stat-row">STATUS: <span style="color:#0f0">ONLINE</span></div>
                <div class="stat-row">ANOMALIES: <span id="anomaly-count">0</span> / 4</div>
            </div>
        </div>
    </div>

    <!-- MENUS (WHITE THEME) -->
    <div id="menu-screen" class="screen-overlay">
        <h1>ANOMALY WATCH</h1>
        <p>AI POWERED EDITION</p>
        
        <div id="how-to-play">
            <h2>คำสั่งปฏิบัติการ (INSTRUCTIONS)</h2>
            <ul>
                <li><b>ภารกิจ:</b> ตรวจสอบกล้องวงจรปิดทั้ง 4 จุด ตั้งแต่ 00:00 - 06:00 น.</li>
                <li><b>การตรวจสอบ:</b> สังเกตความผิดปกติที่เกิดขึ้นในห้อง (ของหาย, ของเกิน, เงาคน)</li>
                <li><b>การรายงาน:</b> กดปุ่ม <b>REPORT</b> ให้ตรงกับประเภทความผิดปกติเพื่อแก้ไข</li>
                <li><b>คำเตือน:</b> หากความผิดปกติสะสมครบ 4 อย่าง ระบบจะล่ม</li>
            </ul>
        </div>
        
        <div id="ai-intro" class="ai-box">"กดปุ่มอ่านบันทึก เพื่อดูข้อมูลกะดึก..."</div>
        <button id="btn-log" onclick="generateShiftLog()">✨ อ่านบันทึกกะดึก (SHIFT LOG)</button>
        <button class="btn-start" onclick="Game.start()">เริ่มเข้าเวร (CLOCK IN)</button>
    </div>

    <!-- GAME OVER (DARK THEME) -->
    <div id="game-over-screen" class="screen-overlay screen-dark" style="display:none;">
        <h1 style="color:red">SIGNAL LOST</h1>
        <p style="font-size:24px; color:#aaa;">ความผิดปกติเกินขีดจำกัด</p>
        <div id="death-report" class="ai-box"></div>
        <button class="btn-start" onclick="location.reload()">REBOOT SYSTEM</button>
    </div>

    <!-- WIN (DARK THEME) -->
    <div id="win-screen" class="screen-overlay screen-dark" style="display:none;">
        <h1 style="color:#0f0">SHIFT COMPLETE</h1>
        <p style="font-size:24px; color:#aaa;">จบภารกิจ (6:00 AM)</p>
        <div id="win-report" class="ai-box"></div>
        <button class="btn-start" onclick="location.reload()">LOGOUT</button>
    </div>

    <script>
        // --- GEMINI AI INTEGRATION ---
        const apiKey = ""; 

        async function callGemini(prompt) {
            if(!apiKey) return "API Key not found. (AI Disabled)";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Signal Lost...";
            } catch(e) { return "Connection Error..."; }
        }

        async function generateShiftLog() {
            const el = document.getElementById('ai-intro');
            el.innerText = "กำลังดาวน์โหลดบันทึก...";
            const prompt = "แต่งบันทึกยามกะดึกสั้นๆ 2 ประโยค เกี่ยวกับสิ่งที่เคยเจอในบ้านผีสิงแห่งนี้ (เช่น เห็นเงาคน, ได้ยินเสียง) ภาษาไทย ให้ดูน่ากลัวและสมจริง";
            const text = await callGemini(prompt);
            el.innerText = `"${text}"`;
        }

        async function generateDeathReport() {
            const el = document.getElementById('death-report');
            el.innerText = "กำลังวิเคราะห์สาเหตุการเสียชีวิต...";
            const prompt = "เขียนรายงานชันสูตรศพสั้นๆ 1 ประโยค ของยามที่เสียชีวิตปริศนาในหน้าที่ ภาษาไทย (แนวสยองขวัญ SCP)";
            const text = await callGemini(prompt);
            el.innerText = `REPORT: ${text}`;
        }

        async function generateWinReport() {
            const el = document.getElementById('win-report');
            el.innerText = "กำลังบันทึกข้อมูล...";
            const prompt = "เขียนคำชมเชยสั้นๆ 1 ประโยค สำหรับเจ้าหน้าที่ความปลอดภัยที่เอาตัวรอดจากสิ่งเหนือธรรมชาติได้ ภาษาไทย";
            const text = await callGemini(prompt);
            el.innerText = `LOG: ${text}`;
        }

        // --- SOUND ENGINE ---
        const AudioSys = {
            ctx: null,
            ambienceNode: null,
            init: function() {
                if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                if(this.ctx.state === 'suspended') this.ctx.resume();
            },
            play: function(type) {
                if(!this.ctx) return;
                const t = this.ctx.currentTime;
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.connect(g); g.connect(this.ctx.destination);

                if (type === 'static') { 
                    const bSize = this.ctx.sampleRate * 0.2;
                    const b = this.ctx.createBuffer(1, bSize, this.ctx.sampleRate);
                    const d = b.getChannelData(0);
                    for(let i=0;i<bSize;i++) d[i] = Math.random()*2-1;
                    const n = this.ctx.createBufferSource(); n.buffer=b;
                    const ng = this.ctx.createGain();
                    ng.gain.setValueAtTime(0.1, t); ng.gain.exponentialRampToValueAtTime(0.01, t+0.2);
                    n.connect(ng); ng.connect(this.ctx.destination); n.start();
                }
                else if (type === 'click') {
                    o.type='square'; o.frequency.setValueAtTime(800, t);
                    g.gain.setValueAtTime(0.05, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.1);
                    o.start(); o.stop(t+0.1);
                }
                else if (type === 'success') {
                    o.type='sine'; o.frequency.setValueAtTime(600, t); o.frequency.linearRampToValueAtTime(1200, t+0.2);
                    g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.5);
                    o.start(); o.stop(t+0.5);
                }
                else if (type === 'error') {
                    o.type='sawtooth'; o.frequency.setValueAtTime(150, t);
                    g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.3);
                    o.start(); o.stop(t+0.3);
                }
                else if (type === 'spawn') {
                    o.type='triangle'; o.frequency.setValueAtTime(100, t); o.frequency.exponentialRampToValueAtTime(30, t+0.5);
                    g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t+1.0);
                    o.start(); o.stop(t+1.0);
                }
                else if (type === 'scream') {
                    o.type='sawtooth'; o.frequency.setValueAtTime(200, t); o.frequency.linearRampToValueAtTime(1000, t+0.5);
                    g.gain.setValueAtTime(0.4, t); g.gain.linearRampToValueAtTime(0, t+1.5);
                    o.start(); o.stop(t+1.5);
                }
                else if (type === 'win') {
                    o.type='sine'; o.frequency.setValueAtTime(440, t);
                    g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t+2.0);
                    o.start(); o.stop(t+2.0);
                }
            },
            startAmbience: function() {
                if(this.ambienceNode) return;
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.type='sine'; o.frequency.value=50; // Low hum
                g.gain.value=0.02;
                o.connect(g); g.connect(this.ctx.destination);
                o.start();
                this.ambienceNode = o;
            }
        };

        // --- GAME DATA ---
        const ROOMS = [
            { id: 0, name: 'LIVING ROOM', objects: [] },
            { id: 1, name: 'KITCHEN', objects: [] },
            { id: 2, name: 'BEDROOM', objects: [] },
            { id: 3, name: 'BATHROOM', objects: [] }
        ];

        // Detailed Objects (Base State)
        const BASE_OBJECTS = {
            0: [ // Living Room
                { id: 'wall', type: 'room_bg', color: '#1a1a1a' },
                { id: 'window', type: 'window', x: 250, y: 50, w: 140, h: 100 },
                { id: 'sofa', type: 'sofa', x: 180, y: 280, w: 280, h: 100, color: '#3f2a2a' },
                { id: 'tv_stand', type: 'tv_stand', x: 50, y: 220, w: 120, h: 150 },
                { id: 'painting', type: 'painting', x: 500, y: 80, w: 80, h: 100 },
                { id: 'lamp', type: 'lamp', x: 500, y: 250, w: 40, h: 120 },
                { id: 'rug', type: 'rug', x: 200, y: 380, w: 240, h: 60 }
            ],
            1: [ // Kitchen
                { id: 'wall', type: 'room_bg', color: '#222' },
                { id: 'cabinet_top', type: 'cabinet', x: 100, y: 50, w: 300, h: 80 },
                { id: 'fridge', type: 'fridge', x: 450, y: 120, w: 120, h: 250 },
                { id: 'counter', type: 'counter', x: 100, y: 280, w: 300, h: 120 },
                { id: 'table', type: 'table', x: 200, y: 350, w: 180, h: 80 },
                { id: 'chair', type: 'chair', x: 170, y: 360, w: 40, h: 70 }
            ],
            2: [ // Bedroom
                { id: 'wall', type: 'room_bg', color: '#151520' },
                { id: 'window_tall', type: 'window_tall', x: 280, y: 50, w: 80, h: 150 },
                { id: 'bed', type: 'bed', x: 150, y: 280, w: 250, h: 120 },
                { id: 'wardrobe', type: 'wardrobe', x: 480, y: 150, w: 120, h: 250 },
                { id: 'bedside', type: 'bedside', x: 100, y: 320, w: 40, h: 50 }
            ],
            3: [ // Bathroom (Detailed!)
                { id: 'wall', type: 'room_bg', color: '#203030' },
                { id: 'mirror', type: 'mirror', x: 220, y: 60, w: 100, h: 120 },
                { id: 'sink', type: 'sink', x: 200, y: 200, w: 140, h: 150 },
                { id: 'bathtub', type: 'bathtub', x: 50, y: 280, w: 200, h: 100 },
                { id: 'toilet', type: 'toilet', x: 450, y: 250, w: 80, h: 130 },
                { id: 'towel_rack', type: 'towel', x: 550, y: 150, w: 10, h: 60 },
                { id: 'mat', type: 'rug', x: 250, y: 380, w: 100, h: 40, color: '#446' }
            ]
        };

        // --- GAME ENGINE ---
        const Game = {
            canvas: document.getElementById('gameCanvas'),
            ctx: document.getElementById('gameCanvas').getContext('2d'),
            width: 640, height: 480,
          
